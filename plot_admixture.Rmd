---
title: "R Notebook"
output: html_notebook
---
#Dependencies
```{r}
library(tictoc)
library("devtools", lib.loc="~/R/win-library/3.5")
library("genepop", lib.loc="~/R/win-library/3.5")
library("diveRsity", lib.loc="~/R/win-library/3.5")
library("adegenet", lib.loc="~/R/win-library/3.5")
library("xlsx", lib.loc="~/R/win-library/3.5")
library("sendplot", lib.loc="~/R/win-library/3.5")
library(dplyr)
```
#genepop metadata
```{r}
#read genepop that we derived the admixture data from
#this will allow us to generalize our metadata in the figure
#e.g. n samples per population
SNPs_gen = read.genepop('../v6_snps_publish.2.recode.gen', ncode = 3)

#extract n samples per population
n_by_pop = as.data.frame(matrix(NA,nrow = n_distinct(SNPs_gen$pop), ncol = 1))
for (i in 1:n_distinct(SNPs_gen$pop)) {
  n_by_pop[i,1] = length(which(SNPs_gen$pop == unique(SNPs_gen$pop)[i]))
}
#expand the point data to a format that will fit our genind
n_by_pop$V1 = as.double(n_by_pop$V1)
n_by_pop_strata = NULL
for (i in 1:nrow(n_by_pop)) {
  n_by_pop_strata = c(n_by_pop_strata,rep(x = n_by_pop[i,1],times = n_by_pop[i,1]))
}
n_by_pop_strata = as.data.frame(n_by_pop_strata)

#make n_by_pop cumulative counts to give x values for labels
x_lab_vec = NULL
for (i in 1:nrow(n_by_pop)) {
  x_lab_vec = c(x_lab_vec, sum(n_by_pop[1:i,"V1"]))
}

#extract population names, removing the ID number that gets pulled in from the first sample
pop_IDs = SNPs_gen$pop
pop_IDs = gsub("\\d+","",pop_IDs)
pop_IDs = gsub("-","",pop_IDs)
pop_IDs = as.data.frame(pop_IDs)

#now merge the metadata with the genind
strat_dat = cbind.data.frame(n_by_pop_strata,pop_IDs)
strata(SNPs_gen) = strat_dat

SNPs_gen$strata$n_by_pop_strata
SNPs_gen@strata@pop_IDs

#initialize a palette of colors we can use downstream, 23 unique hexidecimal colors here
PCA23_palette = c("#000ffF","#0033CC","#006699","#009966","#006600",
"#66CC00","#CCFF00","#CC9900","#CC3300","#CC0033",
"#CC0099","#CC00FF","#6633FF","#CC66FF","#FF66CC",
"#FF3366","#FF6633","#FF9900","#6699ff","#33ccff","#00ffff","#00ff99")
```
#plot admixture (loop)
This loop assumes you've run admxture for a sequence of K values
  To use: 
    Reset the values i iterates over to start and end at your sequence min/max for K
    Reset the file name on the read_name variable so the loop will generalize for your data

```{r}
for (i in 6:10) {
read_name = paste(c("../v6_snps_publish2recode.",as.character(i),".Q"),collapse = "")
  tbl = read.table(read_name)
  barplot(t(as.matrix(tbl)), col = PCA23_palette[1:i], xlab = i, ylab = "Admixture", border = "NA",
          ylim = c(0,1),xlim = c(0,845))
  text(x = x_lab_vec,
       y = rep(0,time = 21),
       as.vector(unique(pop_IDs$pop_IDs)),
       adj = 0,srt = 90)
}


read_name = paste(c("../v6_snps_publish2recode.",as.character(i),".Q"),collapse = "")
  tbl = read.table(read_name)
  barplot(t(as.matrix(tbl)), col = PCA23_palette[1:i], xlab = i, ylab = "Admixture", border = "NA",
          ylim = c(0,1),xlim = c(0,845))
  text(x = 900,
       y = 0,
       as.vector(unique(pop_IDs$pop_IDs)),
       adj = 0,srt = 90)
```
#exploring ggplot option
```{r}
#requires ggplot2 and reshape pkgs
tmp = as.data.frame(t(tbl))
tmp2 = melt(tmp)
rownames(tmp) = c(1:nrow(tmp))
tmp2$grp = c(1:length(which(tmp2$variable == unique(tmp2$variable)[1])))

ggplot() + geom_bar(aes(y = value, x = variable, fill = factor(grp)), data = tmp2, stat = "identity")

ggplot(tmp2, aes(x = variable, fill = factor(value)))+ geom_bar(position = "fill")
  position_stack()
```


